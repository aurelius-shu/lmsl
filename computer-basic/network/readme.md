# 计算机网络

## 概述

ISP - 互联网服务提供商
IXP - 互联网交换点

### 主机通信方式

1. C/S
2. P2P

### 交换方式

1. 电路交换
2. 分组交换

### 时延

1. 排队时延
2. 处理时延
3. 传输时延
4. 传播时延

### 计算机网络体系结构

1. OSI
2. 五层协议
3. TCP/IP

## 物理层

### 通信方式

1. 单工通信
2. 半双工通信
3. 全双工通信

### 带通调制

数字信号 -> 模拟信号

## 链路层

封装成帧
透明传输
差错检测（CRC）

### 信道分类

1. 广播信道（CSMA/CD 协议）
2. 点对点信道（PPP 协议）

### 信道复用技术

1. 频分复用
2. 时分复用（固定用户时间位置）
3. 统计时分复用（不固定用户时间位置）
4. 波分复用
5. 码分复用

### CSMA/CD 协议

1. 多点接入
2. 载波监听
3. 碰撞检测

### PPP 协议

主机与 ISP 进行通信时的数据链路层协议

### MAC 地址

链路层地址 - 物理地址（网络适配器标识）

### 局域网

一种广播信道，地理范围和站点数有限

**拓扑结构**

1. 星型
2. 环型
3. 直线型

### 以太网

一种星型拓扑结构的局域网

集线器 -> 交换机

### 交换机

交换表（MAC 地址 -> 接口）

### 虚拟局域网

与物理位置无关的逻辑组

## 网络层

IP +
ARP(Address Resolution Protocol) +
ICMP(Internet Control Message Protocol) +
IGMP(Internet Group Management Protocol)

### IP 地址编址

1. 分类
2. 子网划分
3. 无分类

### 内网专用地址块

1. 10.0.0.0 ~ 10.255.255.255
2. 172.16.0.0 ~ 172.31.255.255
3. 192.168.0.0 ~ 192.168.255.255

### ARP(地址解析协议)

ARP 高速缓存（主机与路由器的 IP -> MAC 地址）

### ICMP(网际控制报文协议)

封装在 IP 数据报中，有效转发 IP 数据包，提高交互成功几率

**ICMP 应用**

1. ping
2. traceroute

### VPN 虚拟专用网

两端与互联网相连的路由器 R1、R2
R1 对数据加密封装数据报 -> 公网传输 -> R2 解密恢复源数据报

### NAT 网络地址转换

通过 IP + 端口将本地 IP 转换成全球 IP

### 路由器

#### 功能

1. 路由选择
2. 分组转发

#### 组成部分

1. 交换结构
2. 一组输入端口
3. 一组输出端口

#### 转发流程

1. 从报文首部获取目的 IP 地址 D、网络地址 N
2. 若 N 就是路由器相连的地址，直接交付
3. 若路由表存在目的为 D 的特定主机路由，传送至表中的下一跳路由器
4. 若路由表存在目的为 N 的路由，传送至表中的下一跳路由器
5. 若路由表存在默认路由，传送至表中的默认路由器
6. 报告转发分组出错

### 路由选择协议

AS - 自治系统

#### RIP 内部网关协议

距离向量算法

#### OSPF 内部网关协议

最短路径优先

#### BGP 外部网关协议

BGP 发言人

## 传输层

### UDP(User Datagram Protocol)

尽最大可能交互，面向报文，无拥塞控制，支持一对一、一对多、多对一、多对多

#### 首部

1. 源端口
2. 目标端口
3. 长度
4. 校验和

### TCP(Transmission Control Protocol)

提供可靠交付，面向连接，面向字节流，全双工通信，有流量控制、拥塞控制，只支持点对点（一对一）

#### 首部

1. 序号
2. 确认号
3. 数据偏移量
4. ACK 确认
5. SYN 同步
6. FIN 终止
7. 窗口

#### 三次握手

SYN=1,seq=x ->
SYN=1,ACK=1,seq=y,ack=x+1 ->
ACK=1,seq=x+1,ack=y+1

Client: Closed -> SYN-Sent -> Established
Server: Closed -> SYN-Rcvd -> Established

**原因**

（超时重传 ->）防止失效的连接请求达到服务器，让服务器错误打开连接

#### 四层挥手

FIN=1,seq=u ->
ACK=1,seq=v,ack=u+1
FIN=1,seq=w,ACK=1,ack=u+1 ->
ACK=1,seq=u+1,ack=w+1

Client: Established -> FIN-Wait1 -> FIN-Wait2 -> Time-Wait(2MSL) -> Closed
Server: Established -> Close-Wait -> Last-Wait -> Closed

**原因**

`Close-Wait`

1. 是为了保障服务器发送完还未传送完毕的数据

`Time-Wait`

1. 保障最后一个 ACK 报文能到达 Server，否则 Server 会重新发送 FIN 报文
2. 让本次连接内产生的所有报文从网络消失，避免下次新连接中出现旧连接的报文

#### 可靠传输

超时(RTO)没有收到确认 -> 重传

#### 滑动窗口

接收方的 TCP 报文中窗口字段及其他信息 -> 发送窗口大小
发送方窗口左部字节确认收到后，窗口右滑
接收方窗口确认左部字节收到，并右滑窗口

#### 流量控制

接收方控制发送方窗口大小 -> 控制发送方发送速率，保证接收方来得及接收

#### 拥塞控制

`cwnd` 拥塞窗口
`ssthresh` 慢开始门限

1. 慢开始(cwnd=1)
2. 拥塞避免(ssthresh -> cwnd+=1)
3. 快重传(3 个连续的 M2 确认报文 -> 立即快重传 M3)
4. 快恢复(ssthresh=cwnd/2, cwnd=ssthresh)

## 应用层

### DNS(53)

**域名系统**

### FTP(20/21)

**文件传输协议**

1. 控制连接(21)
2. 数据连接(22)

#### 主动模式

服务器(20)主动连接客户端(>1024,随机,设置开放端口号)

#### 被动模式

客户端(自定义)主动连接服务器(随机,设置开放端口号)

### DHCP(67/68)

**Dynamic Host Configuration Protocol**

配置 IP 地址、网关 IP、子网掩码、DNS IP

1. Client 通过 UDP 从 0.0.0.0:68 广播发送 discover 报文给 255.255.255.255:67
2. DHCP Server 收到 discover 报文后，发送 offer(包含配置信息) 给 Client
3. Client 收到若干个 DHCP Server 的 offer 后，选择其中一个，并发送 request 报文给改 DHCP Server
4. DHCP Server 发送 ACK 报文，表示 Client 可以使用该 offer 中的配置

### TELNET(23)

**远程登录协议**

### SMTP、POP3、IMAP

#### 邮件系统组成

1. 用户代理
2. 邮件服务器
3. 邮件协议

SMTP(25) - 发送协议，只能发送 ASCII，配合 MIME 互联网邮件扩展使用
POP3(110) - 接收协议，用户读取邮件后，服务器删除邮件
IMAP(143) - 接收协议，客户端与服务器上同步，用户手动删除才会删除服务器上的邮件

### Web 页面请求过程

1. DHCP 配置主机信息(应用层)
2. ARP 解析 MAC 地址(链路层，获取链路段的 MAC 地址)
3. DNS 解析域名(应用层，获取目标 IP)
4. HTTP 请求页面
   - Client 通过 DNS 获取目标 IP
   - Client 与 Server 三次握手建立 TCP 连接，生成 TCP 套接字
   - Client 发送 HTTP Get 报文
   - Server 接收到 HTTP Get 报文，生成一个 HTTP 响应报文，在报文主体写入 Web 页面内容，发回 Client
   - Client 接收 HTTP 响应报文，抽取 Web 页面内容，渲染显示
